<html>
  <head>
    <title>Waterworks Prototype</title>

    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="layout.css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script>
      $(document).ready(function() {
        start_time();
      });
    </script>

    <script> // story event management
      story_event_messages = {};
      function add_story_event ( event_name, messages ) {
        story_event_messages[event_name] = messages;
      }

      function story_event ( event_id ) {
        private_log(`Story event: ${event_id}`);
        $('.disappear-on-story-event-' + event_id).each(function() {$(this).addClass('hidden');});
        if ( story_event_messages[event_id] ) {
          function print_story_event_message ( messages, i, callback ) {
            if ( i < messages.length ) {
              messages[i](() => print_story_event_message(messages, i+1, callback));
            } else {
              callback();
            }
          }
          print_story_event_message(story_event_messages[event_id], 0, () => {
            $('.appear-on-story-event-' + event_id).each(function() {$(this).removeClass('hidden');});
          });
        }
      }
    </script>
    <script> // resource management
      resources = {};
      function new_resource ( resource_name, base_amount, base_storage ) {
        resources[resource_name] = {
          count: base_amount,
          max: base_storage,
        };
      }
      function add_resource ( resource_name, amount ) {
        if ( !resources[resource_name] )
          throw `Resource ${resource_name} does not exist`;

        resources[resource_name].count = Math.min(
          resources[resource_name].max,
          resources[resource_name].count + amount
        );
      }
      function add_resource_storage ( resource_name, amount ) {
        if ( !resources[resource_name] )
          throw `Resource ${resource_name} does not exist`;

        resources[resource_name].max = resources[resource_name].max + max;
      }
      function get_resource ( resource_name ) {
        if ( !resources[resource_name] )
          new_resource(resource_name, 0, 0);
        return resources[resource_name];
      }
    </script>
    <script> // time management
      time_lag = 0;
      time_delta = 0;
      time_total = 0;
      time_last = null;
      step_size = 1000 / 60;
      frame = null;

      function start_time ( ) {
        lag = 0;
        delta = 0;
        total = 0;
        last = null;

        frame = requestAnimationFrame(tick);
      }
      function stop_time() {
        cancelAnimationFrame(frame);
      }

      function tick ( time ) {
        if (time_last === null) time_last = time;
        time_delta = time - time_last;
        time_total += time_delta;
        time_lag += time_delta;
        time_last = time;

        number_of_updates = Math.floor(time_lag / step_size);
        time_lag -= number_of_updates * step_size;

        on_update(number_of_updates);
        on_render(time_lag / step_size);

        frame = requestAnimationFrame(tick);
      }

      update_events = {};
      function register_update_event ( event_name, callback ) {
        private_log(`Registering update event: ${event_name}`);
        update_events[event_name] = callback;
      }
      function on_update ( number_of_updates ) {
        for ( let event_name in update_events ) {
          update_events[event_name](number_of_updates);
        }
      }

      render_events = {};
      function register_render_event ( event_name, callback ) {
        private_log(`Registering render event: ${event_name}`);
        render_events[event_name] = callback;
      }
      function on_render ( sub_step ) {
        for ( let event_name in render_events ) {
          render_events[event_name](sub_step);
        }
      }
    </script>

  </head>
  <body>
    <noscript>You need to enable JavaScript.</noscript>

    <div id="header">
      <div id="toolbar">
        <button onclick="toggle_debug();">Debug</button>
        <script>
          function toggle_debug ( ) {
            $("html").toggleClass("debug");
            $("#console-private").toggleClass("hidden");
          }
        </script>
        <button class="disappear-on-story-event-snaa disappear-on-story-event-skip" onclick="story_event('skip');">Skip</button>
        <script>
          add_story_event('skip', [
            (callback) => public_log("Skipping everything up to fabricator 1", callback),
            (callback) => {new_resource('mystery_liquid', 100, 100); callback()},
            (callback) => {new_resource('power', 1000, 1000); callback()},
            (callback) => {register_update_event('power_snaa', (number_of_updates) => {
              add_resource('power', step_size * number_of_updates * 0.1);
            }); callback()},
          ]);
        </script>
      </div>
    </div>

    <div id="main-container">
      <div id="container-header">
        <div id="container-power" class="hidden appear-on-story-event-fabricator_1 appear-on-story-event-skip">
          <b>Power</b><br>
          <span id="power-level">0</span>/<span id="power-max">0</span>
          <script>
            $(document).ready(function() {
              register_update_event('power', (sub_step) => {
                $('#power-level').text(Math.floor(get_resource('power').count));
                $('#power-max').text(Math.floor(get_resource('power').max));
              });
            });
          </script>
        </div>
        <div id="container-mystery-liquid" class="hidden appear-on-story-event-mystery_liquid appear-on-story-event-skip">
          <b>Mystery Liquid</b><br>
          <span id="mystery-liquid-level">0</span>/<span id="mystery-liquid-max">0</span>
          <script>
            $(document).ready(function() {
              register_render_event('mystery_liquid', (sub_step) => {
                $('#mystery-liquid-level').text(Math.floor(get_resource('mystery_liquid').count));
                $('#mystery-liquid-max').text(Math.floor(get_resource('mystery_liquid').max));
              });
            });
          </script>
        </div>
      </div>
      <div id="container-console">
        <div id="console-public">

        </div>
        <script>
          message_id = 0;
          function public_log ( message, callback ) {
            id = "console-public-message-" + message_id;
            message_id++;
            private_log(`Writing ${id}: "${message}"`);

            if ( $("#console-public").children().length > 10 ) {
              $("#console-public").children().first().remove();
            }

            $("#console-public").append(`<div><span id="${id}">SNAA: </span></div>`);
            function type_message ( span, message, i ) {
              if ( i < message.length ) {
                span.text(span.text() + message[i]);
                setTimeout(function () {type_message(span, message, i+1)}, 10);
              } else {
                if ( callback ) {
                  callback();
                }
              }
            }
            type_message($("#" + id), message, 0);
          }
        </script>
        <div id="console-private" class="hidden">

        </div>
        <script>
          function private_log ( message ) {
            $("#console-private").append("<div><span style='min-height: 1em'>" + message + "</span></div>");
            if ( $("#console-private").children().length > 10 ) {
              $("#console-private").children().first().remove();
            }
          }
        </script>
      </div>
      <div id="container-story-buttons">
        <div id="story-button-snaa" class="disappear-on-story-event-snaa disappear-on-story-event-skip">
          <button onclick="story_event('snaa');">What is happening?</button>
          <script>
            add_story_event("snaa", [
              (callback) => public_log("Greetings, I am S.N.A.A. (Subtly Named Ai Assistant).", callback),
              (callback) => public_log("I have been sent here by The Board ahead of your arrival.", callback),
              (callback) => public_log("I am to assist you in your work and to \"prevent the idiot from blowing up the place\".", callback),
              (callback) => public_log("", callback),
            ]);
          </script>
        </div>
        <div id="story-button-planet_pnygan" class="hidden appear-on-story-event-snaa disappear-on-story-event-planet_pnygan">
          <button onclick="story_event('planet_pnygan');">Where are we?</button>
          <script>
            add_story_event("planet_pnygan", [
              (callback) => public_log("I am not sure how much you have been told about this place, so let me give you a short summary.", callback),
              (callback) => public_log("We are currently on a platform in orbit around Pnygan (Planet not yet given a name),", callback),
              (callback) => public_log("a \"planet\" The Board has kept secret for many decades that completely consists of a mysterious, disturbingly pink, liquid.", callback),
              (callback) => public_log("", callback),
            ]);
          </script>
        </div>
        <div id="story-button-mystery_liquid" class="hidden appear-on-story-event-planet_pnygan disappear-on-story-event-mystery_liquid">
          <button onclick="story_event('mystery_liquid');">Mystery Liquid?</button>
          <script>
            add_story_event("mystery_liquid", [
              (callback) => public_log("Under large enough pressure, this Mystery Liquid breaks down anything, and The Board has been using this to dispose of hazardous materials.", callback),
              (callback) => public_log("It was recently discovered that sending complex patterns of electromagnetic waves through the liquid makes it transform into various materials.", callback),
              (callback) => public_log("This can obviously have huge economical benefits, so you are tasked with experimenting with the liquid.", callback),
              (callback) => public_log("In order to prevent information about this from being leaked, you have been given the absolute bare minimum of resources to start your work.", callback),
              (callback) => public_log("A small pump on the platform brings in mystery liquid from the planets surface.", callback),
              (callback) => {new_resource('mystery_liquid', 100, 100); callback()},
              (callback) => public_log("", callback),
            ]);
          </script>
        </div>
        <div id="story-button-fabricator-1" class="hidden appear-on-story-event-mystery_liquid disappear-on-story-event-fabricator_1">
          <button onclick="story_event('fabricator_1');">What's that weird machine over there?</button>
          <script>
            add_story_event("fabricator_1", [
              (callback) => public_log("That's a small fabricator, which is capable of creating materials requiring small amounts of electricity.", callback),
              (callback) => public_log("I am equipped with a small photovoltaic system used to power the platform.", callback),
              (callback) => {new_resource('power', 1000, 1000); callback()},
              (callback) => {register_update_event('power_snaa', (number_of_updates) => {
                add_resource('power', step_size * number_of_updates * 0.1);
              }); callback()},
              (callback) => public_log("In your absence, I have taken the liberty of experimenting with the small fabricator, and I have found some resources that might be helpful.", callback),
              (callback) => public_log("If you have any questions regarding the materials, don't be afraid to ask.", callback),
              (callback) => public_log("", callback),
            ]);
          </script>
        </div>
          <!-- appear-on-story-event-skip -->
      </div>

      <div id="container-fabricator-1" class="hidden appear-on-story-event-fabricator_1 appear-on-story-event-skip">
        Small Fabricator:
        <div id="container-limestone">
          <b>Limestone</b><button onclick="story_event('explain_limestone');">?</button><br>
          <script>
            add_story_event("explain_limestone", [
              (callback) => public_log("Limestone is a common type of sedimentary rock on Sol-3.", callback),
              (callback) => public_log("It is composed of mostly calcium carbonate (CaCO3), giving access to important construction materials such as mortal and glass.", callback),
              (callback) => public_log("", callback),
            ]);
          </script>
          <span id="limestone-level">0</span>/<span id="limestone-max">0</span>
          <!-- quicklime calcination-->
        </div>
        <div id="container-sandstone">
          <b>Sandstone</b><button onclick="story_event('explain_sandstone');">?</button><br>
          <script>
            add_story_event("explain_sandstone", [
              (callback) => public_log("Sandstone is a common type of sedimentary rock on Sol-3.", callback),
              (callback) => public_log("Consisting mostly of quartz, it can be crushed to give easy access to silica.", callback),
              (callback) => public_log("", callback),
            ]);
          </script>
          <span id="sandstone-level">0</span>/<span id="sandstone-max">0</span>
        </div>
        <div id="container-shale">
          <b>Shale</b><button onclick="story_event('explain_shale');">?</button><br>
          <script>
            add_story_event("explain_shale", [
              (callback) => public_log("Shale is the most common sedimentary rock on Sol-3.", callback),
              (callback) => public_log("Fine-grained and consisting of many thin layers, shale primarily consists of clay minerals and quartz.", callback),
              (callback) => public_log("", callback),
            ]);
          </script>
          <span id="shale-level">0</span>/<span id="shale-max">0</span>
          <!-- 58% clay minerals, 28% quartz, 6% feldspar, 5% carbonate minerals, and 2% iron oxides -->
        </div>
        <div id="container-water">
          <b>Water</b><button onclick="story_event('explain_water');">?</button><br>
          <script>
            add_story_event("explain_water", [
              (callback) => public_log("Water is the most important resource in the universe.", callback),
              (callback) => public_log("The small, polar structure gives water incredible properties, like making it one of the best solvents.", callback),
              (callback) => public_log("", callback),
            ]);
          </script>
          <span id="water-level">0</span>/<span id="water-max">0</span>
        </div>
        <div id="container-wood">
          <b>Wood</b><button onclick="story_event('explain_wood');">?</button><br>
          <script>
            add_story_event("explain_wood", [
              (callback) => public_log("Wood is used to refer to carbon-based polymer materials.", callback),
              (callback) => public_log("It is said that large parts of Sol-3 used to be covered in wood based organisms called trees.", callback),
              (callback) => public_log("", callback),
            ]);
          </script>
          <span id="wood-level">0</span>/<span id="wood-max">0</span>
        </div>
      </div>
      <!--
        <div id="container-dolomite">
          <b>Dolomite</b><button onclick="explain_dolomite();">?</button><br>    CaMg(CO3)2
          <script>
            function explain_dolomite ( ) {

            }
          </script>
        </div>
        Igneous rocks:
        <div id="container-basalt">
          <b>Basalt</b><br>
          Basalt makes up over 90% of all volcanic rock on Sol-3
        </div>
        <div id="container-obsidian">
          <b>Obsidian</b><br>
          Obsidian is volcanic glass formed when silica-rich lava cools rapidly.
        </div>

      Pit firing
      ->

      Pugmilling

      Kiln
      -> bricks
      -> limestone and clay -> Portland cement


      Bauxite;<br>
      - Gibbsite: Al(OH)3<br>
      - Boehmite: gamma-AlO(OH)<br>
      - Diaspore: alpha-AlO(OH)<br>
      - Goethite: FeO(OH)<br>
      - Haematite: Fe2O3<br>
      - Kaolinite: Al2Si2O5(OH)4<br>
      - Anatase: TiO2<br>
      - Ilmenite: FeO.TiO2<br>
      - Gallium<br>
      <br>
      Oxides:<br>
      - Cassiterite: SnO2<br>
      - Chromite: (Fe,Mg)Cr2O4<br>
      - Hematite: Fe2O3<br>
      - Magnetite: Fe2+Fe3+2O4<br>
      - Pyrolusite: MnO2<br>
      - Uraninite: UO2<br>
      - Wolframite: (Fe,Mn)WO4<br>
      <br>
      Carbonates:<br>
      - Calcite: CaCO3<br>
      - Dolomite [Sedimentary Rock]: CaMg(CO3)2<br>
      - Malachite: Cu2CO3(OH)2<br>
      - Rhodochrosite: MnCO3<br>
      - Siderite: FeCO3 | 48% Fe<br>
      - Smithsonite: ZnCO3<br>
      <br>
      Silicates:<br>
      - Quartz: SiO2<br>
      <br>
      Cyclosilicates:<br>
      - Beryl: Be3Al2Si6O18<br>
      <br>
      Halides:<br>
      - Fluorite: CaF2<br>
      - Halite: NaCl<br>
      <br>
      Sulfides:<br>
      - Acanthite: Ag2S<br>
      - Arsenopyrite: FeAsS | 35% Fe, 40% As, 5% Sb, 20% S<br>
      - Bornite: Cu5FeS4 | 63% Cu<br>
      - Chalcocite: Cu2S | 80% Cu<br>
      - Chalcopyrite: CuFeS2<br>
      - Cinnabar: HgS<br>
      - Cobaltite: CoAsS<br>
      - Galena: PbS | 0.8% Ag, 85% Pb, 0.5% Se, -- S<br>
      - Molybdenite: MoS2<br>
      - Pentlandite: (Fe,Ni)9S8<br>
      - Pyrite: FeS2<br>
      - Sphalerite: (Zn, Fe)S | 60% Zn, 7% Fe, 33% S<br>
      - Stannite: Cu2FeSnS4 | 28% Sn, 12% Fe, 30% Cu, 30% S<br>
      - Stibnite: Sb2S3<br>
      <br>
      Sulfates:<br>
      - Alunite: KAl3(SO4)2(OH)6<br>
      - Anglesite: PbSO4<br>
      - Anhydrite: CaSO4<br>
      - Baryte: BaSO4<br>
      - Celestine: SrSO4<br>
      <br>
      Sulfosalts:<br>
      - Andorite: PbAgSb3S6 | 12% Ag, 1% Cu, 22% Pb, 0.3% Fe, 42% Sb, 0.3% Se, -- S<br>
      - Freibergite: (Ag,Cu,Fe)12(Sb,As)4S13<br>
      - Pyrargyrite: Ag3SbS3<br>
      - Stephanite: Ag5SbS4 | 68.8% Ag<br>
      - Tennantite: Cu6[Cu4(Fe,Zn)2]As4S13<br>
      - Tetrahedrite: (Cu,Fe)12Sb4S13<br>
      - Zinkenite: Pb9Sb22S42<br>
      <br>
      Other:<br>
      - Pollucite: (Cs,Na)2Al2Si4O12.2H20<br>
      - Scheelite: CaWO4 | 60.63% W<br>
      - Sperrylite: PtAs2<br>

      -->
    </div>

    <div id="footer">

    </div>

  </body>
</html>
